<script>
  $(document).ready(function(){
    $("#preview").html( $("#contenthtml").val() );

    $("#contenthtml").keyup(function() {
      $("#preview").html( $("#contenthtml").val() );
    });

    function editCoords(c){
      $("#dx").val(c.x);
      $("#dy").val(c.y);
      $("#width").val(c.w);
      $("#height").val(c.h)
    }

    $("#iconBase").Jcrop({
      aspectRatio: 1,
      minSize: [100, 100],
      boxWidth: 800, 
      boxHeight: 400,
      onChange: function editCoords(c){
        //console.log(c.x+","+c.y+","+c.w+","+c.h);
      }
    });

    
    $("#img_id").on('change', function() {
      var img_file = $("option:selected", this).attr("data-bordel");
      console.log(img_file)


      var img = $("<img id='iconBase' />").attr('src', "../images/<%=@post.folder_hash%>/"+img_file).addClass("margin-auto img-icon")
      .load(function() {
        if (!this.complete || typeof this.naturalWidth == "undefined" || this.naturalWidth == 0) {
            console.log('broken image!');
        } else {
            $(".jcrop-holder, #iconBase").remove()
            $(".modal-body").append(img)
            $("#iconBase").Jcrop({
              aspectRatio: 1,
              minSize: [100, 100],
              boxWidth: 800, 
              boxHeight: 400,
              onChange: editCoords
            });
        }
      });
    });

  });
  </script>

  <a href="/admin"> Retour </a>
<div id="title">
  <h1>Edition</h1>
</div>

<div id="contentEdit" class="text-center">
  

  <form action="<%= @form_url %>" method='post' class="form-horizontal">
    
    <div class="col-sm-9 margin-bottom-20">
      <div class="row">
        <label class="col-sm-2 control-label" >Titre</label>
        <div class ="col-sm-10 margin-bottom-20">
            <input type='text' name='titre' value="<%=@post.titre%>" class="form-control col-sm-12" placeholder="Titre">
        </div>
      </div>

      <div class="row">
        <label class="col-sm-2 control-label " >Meta-keywords</label>
        <div class ="col-sm-10 margin-bottom-20">
            <input type='text' name='keywords' value="Not done yet" class="form-control col-sm-12" placeholder="Meta-keywords" readonly="readonly">
        </div>
      </div>

    </div>
    <div class="col-sm-3">
        <img src="<% if @post.icon %>../images/<%=@post.folder_hash%>/<%=@post.icon.file_icon%><% else %>../images/no-image.jpg<%end%>" data-toggle="modal" data-target="#iconModal" title="Modifier l'icône" class="border-soft is-clickable" />      
    </div>

    <hr>

    <div class="row" style="margin-top: 15px; margin-bottom: 15px;">
      <div class="col-sm-6">
        <textarea type='text' id="contenthtml" name='content' rows="20" class="form-control">
          <%=@post.content%> 
        </textarea>
      </div>
      <div class="col-sm-6">
        <div id="preview" class="preview" ></div>
      </div>
    </div>
    
    <div class="row">
      <button type="submit" class="btn btn-default" style="margin: auto; width: 97%;">Valider</button>
    </div>

  </form>

  <hr>
  <div class="row">
    <h3>Galerie d'images</h3>
  </div>

  <%@post.images.each do |img|%>
    <div class="row margin-top-15">
      <div class ="col-sm-2">
        <img src="../images/<%=@post.folder_hash%>/<%=img.file_icon%>" class="img-100 border-soft" />
      </div>
      <div class ="col-sm-9">
        <input type="text" value="<%= img.titre %>" class="form-control"/>
        <input type="text" value='<img src="./images/<%=@post.folder_hash%>/<%=img.file_preview%>" alt="<%=img.titre%>"/>' class="form-control margin-top-15" readonly="readonly" />
      </div>
      <div class ="col-sm-1">
        X +
      </div>
    </div>
  <% end %>

  <hr>
  <form method="post" action='/admin/upload' class="form-horizontal" enctype="multipart/form-data" > 
    <div class="row">
      <input type="hidden" name="id" value="<%=@post.id%>">
      <div class="col-sm-6">
        <input type='file' name='myfile' class="form-control">
      </div>
      <div class="col-sm-4">
        <input type='text' name='titre' placeholder="Titre" class="form-control" placeholder="Titre">
      </div>
      <div class="col-sm-2">
        <button type="submit" class="btn btn-default col-sm-12">Upload</button>
      </div>
    </div>  
  </form>
  <div class="height-50"></div>

  

<!-- Modal de modification de l'icone-->
<div class="modal fade" id="iconModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Fermer"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Changer l'icône du post</h4>
      </div>
      <form action="/admin/icon" method='post' class="form-horizontal">
        <input type="hidden" id="dx" name="dx" value="0"/>
        <input type="hidden" id="dy" name="dy" value="0"/>
        <input type="hidden" id="width" name="width" value="100"/>
        <input type="hidden" id="height" name="height" value="100"/>
        <input type="hidden" name="post_id" value="<%=@post.id%>"/>
        <div class="modal-body text-center">
          <select id="img_id" name="img_id" class="form-control">
            <%@post.images.each do |img|%>
              <option value="<%= img.id%>" data-bordel="<%=img.file_normal%>" ><%= img.titre%></option>
            <% end %>
          </select>
          <img id="iconBase" class="margin-auto img-icon" src="../images/<%=@post.folder_hash%>/<%=@post.images[0].file_normal%>">
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Valider</button>
        </div>

      </form>
    </div>
  </div>
</div>


     <!--  -->

</div>